<!DOCTYPE html>
<html>
<head>
    <title class='title'>Tests</title>
    <link rel='stylesheet' type='text/css' href='../styles/tests.css'/>
    <link rel='icon' type='image/png' href='../images/gear2.png'>
    <script src='../lib/jquery.js'></script>
    <script src='../lib/underscore.js'></script>
    <script src='../require-scripts.js'></script>

</head>
<body>
<a href='../'>../</a>

<h2 class='index'>Test Groups</h2>

<div><p id='index'></p></div>
<h3 class='title'>&nbsp;</h3>

<p id='verify'></p>

<div id='container'></div>
<div class='console'></div>

<script>
    var useSearchPathForAutoload = true;
    var library = {};
    var scripts = {
        'require': 'test-require.js',
        'ammo': 'test-ammo.js',
        'factory': 'test-factory.js',
        'collision': 'test-collision.js',
        'rendering': 'test-render.js',
        'shapes': 'test-shapes.js'
    };

    function loadTest(event) {
        if (!useSearchPathForAutoload) {
            library && library.clearObjects && library.clearObjects();
            $('#container').empty();
            setConsole('.console');
        }
        var title = $(event.target).text();
        $('.title').text('Test: ' + title);
        var script = $(event.target).attr('script');
        library = require(script, undefined);
        var $verify = $('#verify');
        $verify.empty();
        _.each(library.test, function (fun, name) {
            var e = useSearchPathForAutoload ? $('<a />') : $('<button />');
            e.attr({
                'href': '?group=' + title + '&test=' + name,
                'class': 'test',
                'group': title,
                'test': name
            });
            e.text(name);
            $verify.append(e);
        });
        $verify.children('.test').on('click', runTest);
    }

    function runTest(event) {
        if (!useSearchPathForAutoload) {
            library && library.clearObjects && library.clearObjects();
            setConsole('.console');
        }
        var title = $(event.target).text();
        console.info(title);
        library.test[title]();
    }

    function triggerAutoload() {
        var res = {};
        var search = decodeURIComponent(location.search.replace('?', '')).split('&');
        _.each(search, function (pair) {
            var duo = pair.split('=');
            res[duo[0]] = duo[1] || '';
        });
        if (res.group) {
            loadTest({target: $("#index a[group='" + res.group + "']")});
            if (res.test) {
                runTest({target: $("#verify a[test='" + res.test + "']")});
            }
        }
    }

    window.onload = function () {
        var utils = require('test-utils.js', undefined);
        var $index = $('#index');
        _.each(scripts, function (script, title) {
            var e = useSearchPathForAutoload ? $('<a />') : $('<button />');
            e.attr({
                'href': '?group=' + title,
                'class': 'test',
                'group': title,
                'script': script
            });
            e.text(title);
            $index.append(e);
        });
        setConsole('.console');
        if (useSearchPathForAutoload) {
            triggerAutoload();
        } else {
            console.info('ready');
            $index.children('.test').on('click', loadTest);
        }
    };


</script>
</body>
</html>