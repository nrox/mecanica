<!DOCTYPE html>
<html>

<head>
    <title class='title'>ware loader</title>
    <link rel='stylesheet' type='text/css' href='../styles/tests.css'/>
    <link rel='icon' type='image/png' href='../images/gear2.png'>
    <script src='../lib/jquery.js'></script>
    <script src='../lib/underscore.js'></script>
    <script src='../util/require.js'></script>
</head>

<body>
<p>
    <a href='../'>../</a> <a href=''>reload</a>
</p>

<p>
    <select id='list'>
    </select>
    <button onclick='loadFile();'>load</button>
    <button onclick='removeFile();'>remove</button>
</p>

<div id='container'></div>
<div id='triggers'></div>
<pre id='status'></pre>
<div class='console'></div>

<script>
    function reload() {
        location.href = '';
    }
    function loadList() {
        var url = requireURL('ware/');
        var list = [];
        $.ajax(url, {
            async: false,
            dataType: 'text',
            success: function (data) {
                //console.log(data);
                var nodes = $.parseHTML(data);
                $.map($(nodes).filter('table').find('a'), function (a) {
                    var someChars = "asdasd56ghZujdd";
                    var name = $(a).text();
                    var check = name + someChars;
                    if (check.lastIndexOf('.js' + someChars) > -1) {
                        list.push('ware/' + name);
                    }
                });
            }
        });
        if (!list.length) {
            list = _.filter(availablePaths(), function (p) {
                if ((p.indexOf('ware/') == 0) && p.indexOf('.js') > 0) {
                    return p;
                }
            });
        }
        return list.sort();
    }
    function makeList(list) {
        var $list = $('#list');
        _.each(list, function (file) {
            var o = new Option(file, file, undefined, undefined);
            $list.append(o);
        });
        $list.on('change', function (e) {
            var file = $(e.target).val();
            var obj = require(file).defaultOptions;
            ui.reuseWith({values: obj, container: '#triggers'});
        });
        $list.trigger('change');
    }
    function loadFile() {
        removeFile();
        var file = $('#list').val();
        if (mecanica.getSystem(file)) {
            console.warn('system ' + file + ' already loaded');
        } else {
            var sys = mecanica.importSystem(file, file, ui.getValues());
            mecanica.addToScene();
            var controlsOptions = require(file).userInterface;
            if (controlsOptions) {
                controlsOptions = controlsOptions({
                    system: sys.options().id,
                    container: '#triggers'
                });
                controls.reuseWith(controlsOptions);
            } else {
                controls.destroy();
            }
        }
    }
    function removeFile() {
        var file = $('#list').val();
        var system = mecanica.getSystem(file);
        if (system) system.destroy();
    }
</script>
<script>
    var utils = require('../util/utils.js');
    var lib = require('../mecanica.js');
    var mecanica = new lib.Mecanica();
    mecanica.import('../ware/settings/tests.js');
    mecanica.import('../ware/scene/simple.js');
    mecanica.import('../ware/light/set3.js');
    mecanica.import('../ware/monitor/satellite.js', {distance: 10});
    mecanica.addToScene();
    mecanica.start();
    var ui = new lib.UserInterface({
        values: {},
        container: '#triggers'
    }, mecanica);
    var controls = new lib.UserInterface({
        values: {},
        container: '#triggers'
    }, mecanica);
    makeList(loadList());
</script>
</body>
</html>